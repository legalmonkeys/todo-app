<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>TODO Items</title>
    <link href="#" rel="stylesheet" th:href="@{/css/style.css(v=2)}"></link>
    <script defer="defer" th:src="@{/js/reorder.js(v=2)}"></script>
    <style>
        /* Embedded CSS for simplicity */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }

        main {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin: 0;
        }

        .back-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
            padding: 8px 16px;
            border: 1px solid #007bff;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .back-link:hover {
            background: #007bff;
            color: white;
        }

        .create-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
        }

        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        button:hover {
            background: #0056b3;
        }

        .item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.2s;
            cursor: move;
        }

        .item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .item.drag-over {
            border-color: #007bff;
            border-width: 2px;
        }

        .item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .item.completed {
            background: #f8f9fa;
            opacity: 0.7;
        }

        .item-content {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 15px;
        }

        .drag-handle {
            color: #6c757d;
            font-size: 18px;
            cursor: grab;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }


        .item-text {
            font-size: 16px;
            color: #2c3e50;
        }

        .item.completed .item-text {
            text-decoration: line-through;
            color: #6c757d;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-toggle {
            background: #28a745;
            color: white;
        }

        .btn-toggle:hover {
            background: #218838;
        }

        .btn-toggle.completed {
            background: #6c757d;
        }

        .btn-toggle.completed:hover {
            background: #545b62;
        }

        .btn-important {
            background: #ffc107;
            color: #212529;
        }

        .btn-important:hover {
            background: #e0a800;
        }

        .btn-important.important {
            background: #ff6b35;
            color: white;
        }

        .btn-important.important:hover {
            background: #e55a2b;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .no-items {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px 0;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .list-title {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            main {
                padding: 20px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .item-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
<main>
    <div class="header">
        <div>
            <div class="list-title" th:if="${list}">List:</div>
            <h1 th:if="${list}" th:text="${list.name}">List Name</h1>
            <h1 th:unless="${list}">TODO Items</h1>
        </div>
        <a class="back-link" href="/lists">← Back to Lists</a>
    </div>

    <!-- Error message display -->
    <div class="error" th:if="${error}" th:text="${error}">
        Error message will appear here
    </div>

    <!-- Create new item form -->
    <form class="create-form" id="create-item-form" method="post"
          th:action="@{/api/lists/{id}/items(id=${list.id})}" th:if="${list}">
        <div class="form-group">
            <label for="text">Add New Item:</label>
            <input id="text" maxlength="50" name="text" placeholder="Enter item text (max 50 characters)" required="required"
                   type="text"/>
        </div>
        <button type="submit">Add Item</button>
    </form>

    <!-- Items container -->
    <div id="items-container">
        <!-- Display items if any exist -->
        <div th:if="${hasItems}">
            <div class="item" draggable="true" th:classappend="${item.completed} ? 'completed' : ''"
                 th:data-item-id="${item.id}" th:data-position="${item.position}"
                 th:each="item,iterStat : ${items}">
                <div class="item-content">
                    <span class="drag-handle" title="Drag to reorder">::</span>
                    <div class="item-text" th:text="${item.text}">Item Text</div>
                </div>
                <div class="item-actions">
                    <form method="post" style="display: inline;" th:action="@{/api/items/{id}/toggle(id=${item.id})}">
                        <input name="_method" type="hidden" value="patch"/>
                        <button class="btn-sm btn-toggle" th:classappend="${item.completed} ? 'completed' : ''"
                                th:text="${item.completed} ? 'Undo' : 'Done'"
                                type="submit">
                            Toggle
                        </button>
                    </form>
                    <form method="post" style="display: inline;" th:action="@{/api/items/{id}/toggle-important(id=${item.id})}">
                        <input name="_method" type="hidden" value="patch"/>
                        <button class="btn-sm btn-important" th:classappend="${item.important} ? 'important' : ''"
                                th:text="${item.important} ? '★' : '☆'"
                                type="submit" title="Toggle Important">
                            Important
                        </button>
                    </form>
                    <form method="post" style="display: inline;" th:action="@{/api/items/{id}(id=${item.id})}">
                        <input name="_method" type="hidden" value="delete"/>
                        <button class="btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this item?')"
                                type="submit">
                            Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Show message when no items exist -->
        <div class="no-items" th:unless="${hasItems}">
            <p th:if="${list}">No items in this list yet. Add your first item above!</p>
            <p th:unless="${list}">List not found or no items available.</p>
        </div>
    </div>
</main>

<script>
    // Simple JavaScript for form handling
    const createForm = document.getElementById('create-item-form');
    if (createForm) {
        createForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const text = formData.get('text');

            if (!text || text.trim() === '') {
                alert('Please enter item text');
                return;
            }

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({text: text.trim()})
                });

                if (response.ok) {
                    // Reload the page to show the new item
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    alert('Error: ' + (errorData.message || 'Failed to create item'));
                }
            } catch (error) {
                alert('Error: Failed to create item');
            }
        });
    }

    // Handle toggle and delete forms
    document.querySelectorAll('form[action*="/toggle"]').forEach(form => {
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            try {
                const response = await fetch(this.action, {
                    method: 'PATCH'
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to toggle item');
                }
            } catch (error) {
                alert('Error: Failed to toggle item');
            }
        });
    });

    document.querySelectorAll('form[action*="/items/"]').forEach(form => {
        if (form.action.includes('/toggle')) return; // Skip toggle forms

        form.addEventListener('submit', async function (e) {
            if (!confirm('Are you sure you want to delete this item?')) {
                e.preventDefault();
                return;
            }

            e.preventDefault();

            try {
                const response = await fetch(this.action, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to delete item');
                }
            } catch (error) {
                alert('Error: Failed to delete item');
            }
        });
    });
</script>
</body>
</html>
